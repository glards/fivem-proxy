using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Protocol;
using Protocol.FiveM;
using Sewer56.BitStream;
using Sewer56.BitStream.ByteStreams;
using Xunit;
using Xunit.Abstractions;

namespace FPUnitTests.FiveM
{
    public class ClonePacketTest
    {
        private readonly ITestOutputHelper _output;
        public ClonePacketTest(ITestOutputHelper output)
        {
            _output = output;
        }

        [Fact]
        public void PlayerSpwanTest()
        {
            string packetStr = "A000118CF800000004B8CB0000800000005864801486B88A64803800683FE0008D0005840134001A27192631400010100040C0314A1FF00600000000000000FFFF801B000050FE7E000000C841002AB000000000200431BB82E4F810606B88A6480000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005C602B39800000000400400002000A4C007C02136004014C4914B4D96F808000000240028008005001000A00200140040028008005001000A002003500400C4009C0000014DC070";

            var packet = Convert.FromHexString(packetStr);

            CloneParser parser = new CloneParser(packet);
            foreach (var act in parser.Parse())
            {
                _output.WriteLine(act.ToString());

                if (act is ClonePacket { ObjectType: var objectType } clonePacket && objectType != 0xFF)
                {
                    var objectTypeEnum = (CloneParser.ObjectType) objectType;

                    _output.WriteLine($">> ObjectType:{objectTypeEnum}");

                    var abs = new ArrayByteStream(clonePacket.SyncData);
                    var bs = new BitStream<ArrayByteStream>(abs);

                    _output.WriteLine($">> SyncTree:{bs.GetBitString()}");
                }
            }
        }

        [Fact]
        public void FuzzyCloneTest()
        {
            string packetLog = "A00F48F3D800000C0D3479800080AE00801D80000000324B5FC84009C5F78A65E4000001388D00100000000060D3006B10508B516DE4150F7FE134802BDE001A01F80022400161004D000689C6498C400004040010200556000000000401501F8CCF20420000000000203AC00000000000000000000000000000000000000000000000000000000000000000000000000007674B08602504082040800003EEE7B67600000000600214B4B0005260096071E300076C2009B1020020031900721A0C76C5FFE13E005CAB0000A000600A624B4DEED040000000223E00140040028008005001000A0020014004006A11805A8012D2D3C31FFA003D4B4F0C7800780000224B4002400000000C19600D621770F4D02982800000001004B3C003403F000448002C2009A000D138C9318800008080020400AAC0000000008010DF30F11C6038C00000000048140000000000000000000000000000000000000000000000000000000000000004474708B0881240C00003A2BD82D8000000006002060610005260096071E300076C2009B1020020031900721A0D06C5FFE150005CAB0000A000600A624E6817CE20100080223E00140040028008005001000A0020014004006A1280598012AEAC03E7D2003CBAB00F980078000005FE84005000000000023001B652CE57155566001F41007A47AF80003F000D00FC00112000B0802A00D10003FFFFFFFE400804000500D96F1E009C00003AA506000FFAD984FAD259B66000000000000000004001C0400188800907801007F1CE000000000018A3382060055861011001A845FD6600485D4AC772D0023A0C3D32A1002409986081380017003C102040603E4080080018012CB8800F04E7C003403F000448002C200A80344000FFFFFFFF9002018001C8013B0000355548042601352000A0000001FFFC00080000008140005000140365BDEDBE700000669C08003FEB473564D770D9A8000000000000000100070100064200241E00401FC7380000000000628CE081801562140460035073FECC0091779F360FA0047C37816A3A004819E2820330002F000A89600782140B9007C8100100030236DD001F11AF8006807E000890005840134001A27192631000010100040C000E4009D80001AAAA40819250180440C2000009010800090800000000007C0004409020000070000008000601AF833FFFF8000A00060CCD00DB00DB0006100A545A33FE32980107D6FF6D618000A00028015580000000010054BE61E2381080000000000802023819B00726FA36AC072C000000000000000000000000000000000000000000000000000000000000000000000000000088E8E41641281220C00003A2BD82D8000000006002139390005260096071E300076C2009B1020020031900721A0C8AC5FFE146005CAB0000A000600A624DAF7B37B8040480223E00140040028008005001000A0020014004006A1180598012BD0C45676A003CF431159002E136004000000000011800DB29672B8AA13A600FA0803D23D7C0001F8006807E0008900058401500688001FFFFFFFF2004020002806C8000054E00000953020007FD70D26CB88D5A3500000000000000002000E02000C4400483C00803F8E700000000000C519C103002AC40808800D41AFF330024F58E6879D8011F0FE00AC980120760EF815C000B801E083029701F204004000C01C0";

            var packet = Convert.FromHexString(packetLog);

            CloneParser parser = new CloneParser(packet);
            foreach (var act in parser.Parse())
            {
                _output.WriteLine(act.ToString());
            }
        }

        [Fact]
        public void CloneSyncFailureTest()
        {
            string packetStr = "A0188FE29800095CAD3351800D812540091216E97CBA00473DF7E976E00490DD0E700CC002A38801E097007F02130400000003002F73C4E0";

            var packet = Convert.FromHexString(packetStr);

            CloneParser parser = new CloneParser(packet);
            foreach (var act in parser.Parse())
            {
                _output.WriteLine(act.ToString());
            }
        }
    }
}
